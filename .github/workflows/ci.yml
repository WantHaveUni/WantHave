name: CI Pipeline

on:
  push:
    branches: [ main, dev ]

jobs:
  test-backend:
    runs-on: [self-hosted, Linux, k8s]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Run Django Tests
        run: |
          cd wantHave_backend
          pip install -r requirements.txt
          python manage.py test

  build-and-push:
    needs: [test-backend]
    runs-on: [self-hosted, Linux, k8s]
    outputs:
      short_sha: ${{ steps.vars.outputs.short_sha }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Login to FH Registry
        uses: docker/login-action@v3
        with:
          registry: registry.kub2.fh-joanneum.at
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Generate Short SHA
        id: vars
        run: echo "short_sha=$(git rev-parse --short=8 HEAD)" >> $GITHUB_OUTPUT

      # --- BUILD FRONTEND ---
      - name: Build & Push Frontend
        run: |
          SHORT_SHA=${{ steps.vars.outputs.short_sha }}
          BRANCH_TAG=${{ github.ref_name }}
          IMAGE_NAME=registry.kub2.fh-joanneum.at/k8s/wanthave/frontend
          
          # Build with SHA tag (for Deployment)
          docker build -t $IMAGE_NAME:$SHORT_SHA -f wantHave_frontend/Dockerfile wantHave_frontend/
          docker push $IMAGE_NAME:$SHORT_SHA
          
          # Build/Tag with Branch name (for Dev convenience)
          docker tag $IMAGE_NAME:$SHORT_SHA $IMAGE_NAME:$BRANCH_TAG
          docker push $IMAGE_NAME:$BRANCH_TAG

      # --- BUILD BACKEND ---
      - name: Build & Push Backend
        run: |
          SHORT_SHA=${{ steps.vars.outputs.short_sha }}
          BRANCH_TAG=${{ github.ref_name }}
          IMAGE_NAME=registry.kub2.fh-joanneum.at/k8s/wanthave/backend
          
          docker build -t $IMAGE_NAME:$SHORT_SHA -f wantHave_backend/Dockerfile wantHave_backend/
          docker push $IMAGE_NAME:$SHORT_SHA
          
          docker tag $IMAGE_NAME:$SHORT_SHA $IMAGE_NAME:$BRANCH_TAG
          docker push $IMAGE_NAME:$BRANCH_TAG

  trigger-gitlab-cd:
    needs: [build-and-push]
    runs-on: [self-hosted, Linux, k8s]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Push to GitLab Mirror
        env:
          GITLAB_REMOTE_URL: ${{ secrets.GITLAB_REMOTE_URL }} 
        run: |
          git remote add gitlab $GITLAB_REMOTE_URL
          git push gitlab ${GITHUB_REF_NAME} --force