name: CI Pipeline

on:
  push:
    branches: [ main, dev ]

jobs:
  test-backend:
    runs-on: [self-hosted, Linux, k8s]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y default-libmysqlclient-dev pkg-config build-essential
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Run Django Tests
        run: |
          cd wantHave_backend
          pip install -r requirements.txt
          python manage.py test

  build-and-push:
    needs: [test-backend]
    runs-on: [self-hosted, Linux, k8s]
    outputs:
      short_sha: ${{ steps.vars.outputs.short_sha }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Login to FH Registry
        uses: docker/login-action@v3
        with:
          registry: registry.kub2.fh-joanneum.at
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Generate Short SHA
        id: vars
        run: echo "short_sha=$(git rev-parse --short=8 HEAD)" >> $GITHUB_OUTPUT

      # --- BUILD FRONTEND ---
      - name: Build & Push Frontend
        run: |
          SHORT_SHA=${{ steps.vars.outputs.short_sha }}
          BRANCH_TAG=${{ github.ref_name }}
          IMAGE_NAME=registry.kub2.fh-joanneum.at/k8s/wanthave/frontend
          
          # 1. Read Version from Chart.yaml
          # We use AppVersion because that is what the Helm Chart uses for the image tag
          # awk '{print $2}' splits by whitespace, ignoring trailing comments
          CHART_VERSION=$(awk '/^appVersion:/ {print $2}' helm/frontend/Chart.yaml | tr -d '"')
          echo "Frontend Chart Version: $CHART_VERSION"

          # 2. Build with SHA (always good for history)
          docker build -t $IMAGE_NAME:$SHORT_SHA -f wantHave_frontend/Dockerfile wantHave_frontend/
          docker push $IMAGE_NAME:$SHORT_SHA
          
          # 3. Tagging Strategy
          if [ "$BRANCH_TAG" = "main" ]; then
            # Production: Tag with Chart AppVersion
            echo "Tagging as Production: $CHART_VERSION"
            docker tag $IMAGE_NAME:$SHORT_SHA $IMAGE_NAME:$CHART_VERSION
            docker push $IMAGE_NAME:$CHART_VERSION
          else
            # Dev: Tag with Branch Name (e.g. 'dev')
            echo "Tagging as Dev: $BRANCH_TAG"
            
            # 1. Match GitLab CI expectation: SHA-dev
            docker tag $IMAGE_NAME:$SHORT_SHA $IMAGE_NAME:$SHORT_SHA-$BRANCH_TAG
            docker push $IMAGE_NAME:$SHORT_SHA-$BRANCH_TAG
            
            # 2. Latest Dev tag (dev)
            docker tag $IMAGE_NAME:$SHORT_SHA $IMAGE_NAME:$BRANCH_TAG
            docker push $IMAGE_NAME:$BRANCH_TAG
            
            # 3. Versioned Dev tag (dev-v0.1.0)
            docker tag $IMAGE_NAME:$SHORT_SHA $IMAGE_NAME:$BRANCH_TAG-v${CHART_VERSION}
            docker push $IMAGE_NAME:$BRANCH_TAG-v${CHART_VERSION}
          fi

      # --- BUILD BACKEND ---
      - name: Build & Push Backend
        run: |
          SHORT_SHA=${{ steps.vars.outputs.short_sha }}
          BRANCH_TAG=${{ github.ref_name }}
          IMAGE_NAME=registry.kub2.fh-joanneum.at/k8s/wanthave/backend
          
          # 1. Read Version from Chart.yaml
          CHART_VERSION=$(awk '/^appVersion:/ {print $2}' helm/backend/Chart.yaml | tr -d '"')
          echo "Backend Chart Version: $CHART_VERSION"

          # 2. Build with SHA
          docker build -t $IMAGE_NAME:$SHORT_SHA -f wantHave_backend/Dockerfile wantHave_backend/
          docker push $IMAGE_NAME:$SHORT_SHA
          

          # 3. Tagging Strategy
          if [ "$BRANCH_TAG" = "main" ]; then
            # Production: Tag with Chart AppVersion
            echo "Tagging as Production: $CHART_VERSION"
            docker tag $IMAGE_NAME:$SHORT_SHA $IMAGE_NAME:$CHART_VERSION
            docker push $IMAGE_NAME:$CHART_VERSION
          else
            # Dev: Tag with Branch Name
            echo "Tagging as Dev: $BRANCH_TAG"
            
            # 1. Match GitLab CI expectation: SHA-dev (e.g. a1b2c3d-dev)
            docker tag $IMAGE_NAME:$SHORT_SHA $IMAGE_NAME:$SHORT_SHA-$BRANCH_TAG
            docker push $IMAGE_NAME:$SHORT_SHA-$BRANCH_TAG
            
            # 2. Latest Dev tag
            docker tag $IMAGE_NAME:$SHORT_SHA $IMAGE_NAME:$BRANCH_TAG
            docker push $IMAGE_NAME:$BRANCH_TAG
            
            # 3. Versioned Dev tag
            docker tag $IMAGE_NAME:$SHORT_SHA $IMAGE_NAME:$BRANCH_TAG-v${CHART_VERSION}
            docker push $IMAGE_NAME:$BRANCH_TAG-v${CHART_VERSION}
          fi

  trigger-gitlab-cd: #Fixing credentials issue
    needs: [build-and-push]
    runs-on: [self-hosted, Linux, k8s]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Push to GitLab Mirror
        env:
          GITLAB_REMOTE_URL: ${{ secrets.GITLAB_REMOTE_URL }} 
        run: |
          # 1. Remove the remote if it already exists (ignore error if it doesn't)
          git remote remove gitlab || true
          
          # 2. Add the remote again with the fresh token/URL
          git remote add gitlab $GITLAB_REMOTE_URL
          
          # 3. Push
          git push gitlab ${GITHUB_REF_NAME} --force