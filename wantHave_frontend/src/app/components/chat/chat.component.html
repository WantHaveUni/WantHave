<div class="chat-container">
    <!-- Sidebar: Conversation List -->
    <div class="chat-sidebar">
        <div class="sidebar-header">
            <h3>Messages</h3>
            <div class="new-chat">
                <input #newChatInput placeholder="User ID"
                    (keyup.enter)="startNewChat(newChatInput.value); newChatInput.value=''">
                <button (click)="startNewChat(newChatInput.value); newChatInput.value=''">+</button>
            </div>
        </div>
        <ul class="conversation-list">
            @for (convo of conversations; track convo.id) {
            <li [class.active]="convo.id === selectedConversation?.id" (click)="selectConversation(convo)">
                <div class="convo-avatar">
                    @let other = getOtherParticipant(convo);
                    @if (other?.profile_picture) {
                    <img [src]="other.profile_picture" class="avatar-image" [alt]="other.username">
                    } @else {
                    <div class="avatar-circle">{{ other?.username?.charAt(0) | uppercase }}</div>
                    }
                </div>
                <!-- <div class="convo-avatar">
                     Placeholder avatar 
                    <div class="avatar-circle">{{ convo.participants[0]?.username?.charAt(0) | uppercase }}</div>
                </div> -->
                <div class="convo-details">
                    <span class="convo-name">
                        {{ other?.username }}
                    </span>
                    @if (convo.product) {
                    <span class="convo-product">
                        Re: {{ convo.product.title }}
                    </span>
                    }
                    @if (convo.last_message) {
                    <span class="convo-last-msg">
                        {{ convo.last_message.content | slice:0:30 }}...
                    </span>
                    }
                </div>
                <button class="delete-convo-btn" (click)="deleteConversation(convo, $event)"
                    title="Delete conversation">
                    üóëÔ∏è
                </button>
            </li>
            }
        </ul>
    </div>

    <!-- Main Chat Window -->
    @if (selectedConversation) {
    <div class="chat-window">
        <!-- Product Banner (if conversation is about a product) -->
        @if (selectedConversation.product) {
        <a class="product-banner" [routerLink]="['/products', selectedConversation.product.id]">
            <div class="product-banner-info">
                <span class="product-banner-title">{{ selectedConversation.product.title }}</span>
                <span class="product-banner-price">‚Ç¨{{ selectedConversation.product.price }}</span>
            </div>
            <span class="product-banner-link">View Product ‚Üí</span>
        </a>
        }

        <div class="chat-header">
            <div class="chat-header-info">
                @let headerOther = getOtherParticipant(selectedConversation);
                @if (headerOther) {
                @if (headerOther.profile_picture) {
                <img [src]="headerOther.profile_picture" class="avatar-image-header" [alt]="headerOther.username">
                } @else {
                <div class="avatar-circle-header">{{ headerOther.username.charAt(0) | uppercase }}</div>
                }
                <span class="chat-header-username">{{ headerOther.username }}</span>
                }
            </div>
            @if (canMakeOffer()) {
            <button class="offer-btn" (click)="openOfferModal()">
                üí∞ Make Offer
            </button>
            }
        </div>

        <!-- Offer Cards Section -->
        @if (offers.length > 0) {
        <div class="offers-section">
            @for (offer of offers; track offer.id) {
            <div class="offer-card" [ngClass]="'status-' + offer.status.toLowerCase()">
                <div class="offer-header">
                    <span class="offer-amount">‚Ç¨{{ offer.amount }}</span>
                    <span class="offer-status">{{ offer.status }}</span>
                </div>
                <div class="offer-details">
                    <span class="offer-from">From: {{ offer.buyer.username }}</span>
                    <span class="offer-date">{{ offer.created_at | date:'short' }}</span>
                </div>

                <!-- Seller Actions for PENDING offers -->
                @if (offer.status === 'PENDING' && isSeller()) {
                <div class="offer-actions">
                    <button class="btn-accept" (click)="respondToOffer(offer.id, true)">‚úì Accept</button>
                    <button class="btn-decline" (click)="respondToOffer(offer.id, false)">‚úó Decline</button>
                </div>
                }

                <!-- Buyer waiting for PENDING offers -->
                @if (offer.status === 'PENDING' && isBuyer()) {
                <div class="offer-waiting">
                    <span>‚è≥ Waiting for seller response...</span>
                </div>
                }

                <!-- Buyer Actions for ACCEPTED offers -->
                @if (offer.status === 'ACCEPTED' && isBuyer()) {
                <div class="offer-actions">
                    <button class="btn-pay" (click)="payOffer(offer)">üí≥ Pay Now</button>
                    <button class="btn-cancel" (click)="cancelOffer(offer.id)">Cancel</button>
                </div>
                }

                <!-- Seller waiting for ACCEPTED offers -->
                @if (offer.status === 'ACCEPTED' && isSeller()) {
                <div class="offer-waiting">
                    <span>‚úì Accepted - Waiting for buyer payment...</span>
                </div>
                }

                <!-- PAID offer - Success message for buyer -->
                @if (offer.status === 'PAID' && isBuyer()) {
                <div class="offer-success">
                    <span>üéâ Payment successful! You purchased this item.</span>
                </div>
                }

                <!-- PAID offer - Success message for seller -->
                @if (offer.status === 'PAID' && isSeller()) {
                <div class="offer-success">
                    <span>üéâ Payment received! Item has been sold.</span>
                </div>
                }

                <!-- DECLINED offer -->
                @if (offer.status === 'DECLINED') {
                <div class="offer-declined">
                    <span>‚ùå Offer was declined</span>
                </div>
                }

                <!-- CANCELLED offer -->
                @if (offer.status === 'CANCELLED') {
                <div class="offer-cancelled">
                    <span>üö´ Offer was cancelled</span>
                </div>
                }
            </div>
            }
        </div>
        }

        <div class="messages-area" #messagesContainer>
            @for (msg of messages; track msg.id || msg.timestamp) {
            <div class="message-bubble" [class.sent]="msg.sender.id === currentUser?.id"
                [class.received]="msg.sender.id !== currentUser?.id">

                @if(msg.sender.id !== currentUser?.id) {
                @if(msg.sender.profile_picture) {
                <img [src]="msg.sender.profile_picture" class="msg-avatar" [alt]="msg.sender.username">
                } @else {
                <div class="msg-avatar-placeholder">{{ msg.sender.username?.charAt(0) | uppercase }}</div>
                }
                }

                <div class="message-content">{{ msg.content }}</div>
                <div class="message-time">{{ msg.timestamp | date:'shortTime' }}</div>
            </div>
            }
        </div>

        <div class="chat-input">
            <input [(ngModel)]="newMessage" (keyup.enter)="sendMessage()" placeholder="Type a message..." />
            <button (click)="sendMessage()">Send</button>
        </div>
    </div>
    } @else {
    <div class="empty-state">
        <p>Select a conversation to start chatting</p>
    </div>
    }
</div>

<!-- Offer Modal -->
@if (showOfferModal) {
<div class="modal-overlay" (click)="closeOfferModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Make an Offer</h3>
            <button class="modal-close" (click)="closeOfferModal()">√ó</button>
        </div>
        <div class="modal-body">
            @if (selectedConversation?.product) {
            <p class="product-info">
                Product: <strong>{{ selectedConversation?.product?.title }}</strong><br>
                Listed Price: <strong>‚Ç¨{{ selectedConversation?.product?.price }}</strong>
            </p>
            }
            <div class="form-group">
                <label for="offerAmount">Your Offer (‚Ç¨)</label>
                <input type="number" id="offerAmount" [(ngModel)]="offerAmount" placeholder="Enter your offer amount"
                    min="1" step="0.01">
            </div>
            @if (offerError) {
            <div class="error-message">{{ offerError }}</div>
            }
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" (click)="closeOfferModal()">Cancel</button>
            <button class="btn-submit" (click)="submitOffer()" [disabled]="!offerAmount || offerLoading">
                {{ offerLoading ? 'Sending...' : 'Send Offer' }}
            </button>
        </div>
    </div>
</div>
}