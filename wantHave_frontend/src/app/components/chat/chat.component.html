<div class="chat-container">
    <!-- Sidebar: Conversation List -->
    <div class="chat-sidebar">
        <div class="sidebar-header">
            <h3>Messages</h3>
            <div class="new-chat">
                <input #newChatInput placeholder="User ID"
                    (keyup.enter)="startNewChat(newChatInput.value); newChatInput.value=''">
                <button (click)="startNewChat(newChatInput.value); newChatInput.value=''">+</button>
            </div>
        </div>
        <ul class="conversation-list">
            <li *ngFor="let convo of conversations" [class.active]="convo.id === selectedConversation?.id"
                (click)="selectConversation(convo)">
                <div class="convo-avatar">
                    <!-- Placeholder avatar -->
                    <div class="avatar-circle">{{ convo.participants[0]?.username?.charAt(0) | uppercase }}</div>
                </div>
                <div class="convo-details">
                    <span class="convo-name">
                        <span *ngFor="let p of convo.participants">
                            <span *ngIf="p.id !== currentUser?.id">{{ p.username }}</span>
                        </span>
                    </span>
                    <span class="convo-product" *ngIf="convo.product">
                        Re: {{ convo.product.title }}
                    </span>
                    <span class="convo-last-msg" *ngIf="convo.last_message">
                        {{ convo.last_message.content | slice:0:30 }}...
                    </span>
                </div>
            </li>
        </ul>
    </div>

    <!-- Main Chat Window -->
    <div class="chat-window" *ngIf="selectedConversation; else noSelection">
        <div class="chat-header">
            <div class="chat-header-info">
                <span *ngFor="let p of selectedConversation.participants">
                    <span *ngIf="p.id !== currentUser?.id">{{ p.username }}</span>
                </span>
                <span class="product-badge" *ngIf="selectedConversation.product">
                    | {{ selectedConversation.product.title }} (‚Ç¨{{ selectedConversation.product.price }})
                </span>
            </div>
            <button *ngIf="canMakeOffer()" class="offer-btn" (click)="openOfferModal()">
                üí∞ Make Offer
            </button>
        </div>

        <!-- Offer Cards Section -->
        <div class="offers-section" *ngIf="offers.length > 0">
            <div *ngFor="let offer of offers" class="offer-card" [ngClass]="'status-' + offer.status.toLowerCase()">
                <div class="offer-header">
                    <span class="offer-amount">‚Ç¨{{ offer.amount }}</span>
                    <span class="offer-status">{{ offer.status }}</span>
                </div>
                <div class="offer-details">
                    <span class="offer-from">From: {{ offer.buyer.username }}</span>
                    <span class="offer-date">{{ offer.created_at | date:'short' }}</span>
                </div>

                <!-- Seller Actions for PENDING offers -->
                <div class="offer-actions" *ngIf="offer.status === 'PENDING' && isSeller()">
                    <button class="btn-accept" (click)="respondToOffer(offer.id, true)">‚úì Accept</button>
                    <button class="btn-decline" (click)="respondToOffer(offer.id, false)">‚úó Decline</button>
                </div>

                <!-- Buyer waiting for PENDING offers -->
                <div class="offer-waiting" *ngIf="offer.status === 'PENDING' && isBuyer()">
                    <span>‚è≥ Waiting for seller response...</span>
                </div>

                <!-- Buyer Actions for ACCEPTED offers -->
                <div class="offer-actions" *ngIf="offer.status === 'ACCEPTED' && isBuyer()">
                    <button class="btn-pay" (click)="payOffer(offer)">üí≥ Pay Now</button>
                    <button class="btn-cancel" (click)="cancelOffer(offer.id)">Cancel</button>
                </div>

                <!-- Seller waiting for ACCEPTED offers -->
                <div class="offer-waiting" *ngIf="offer.status === 'ACCEPTED' && isSeller()">
                    <span>‚úì Accepted - Waiting for buyer payment...</span>
                </div>
            </div>
        </div>

        <div class="messages-area">
            <div *ngFor="let msg of messages" class="message-bubble" [class.sent]="msg.sender.id === currentUser?.id"
                [class.received]="msg.sender.id !== currentUser?.id">
                <div class="message-content">{{ msg.content }}</div>
                <div class="message-time">{{ msg.timestamp | date:'shortTime' }}</div>
            </div>
        </div>

        <div class="chat-input">
            <input [(ngModel)]="newMessage" (keyup.enter)="sendMessage()" placeholder="Type a message..." />
            <button (click)="sendMessage()">Send</button>
        </div>
    </div>

    <ng-template #noSelection>
        <div class="empty-state">
            <p>Select a conversation to start chatting</p>
        </div>
    </ng-template>
</div>

<!-- Offer Modal -->
<div class="modal-overlay" *ngIf="showOfferModal" (click)="closeOfferModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Make an Offer</h3>
            <button class="modal-close" (click)="closeOfferModal()">√ó</button>
        </div>
        <div class="modal-body">
            <p class="product-info" *ngIf="selectedConversation?.product">
                Product: <strong>{{ selectedConversation.product.title }}</strong><br>
                Listed Price: <strong>‚Ç¨{{ selectedConversation.product.price }}</strong>
            </p>
            <div class="form-group">
                <label for="offerAmount">Your Offer (‚Ç¨)</label>
                <input type="number" id="offerAmount" [(ngModel)]="offerAmount" placeholder="Enter your offer amount"
                    min="1" step="0.01">
            </div>
            <div class="error-message" *ngIf="offerError">{{ offerError }}</div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" (click)="closeOfferModal()">Cancel</button>
            <button class="btn-submit" (click)="submitOffer()" [disabled]="!offerAmount || offerLoading">
                {{ offerLoading ? 'Sending...' : 'Send Offer' }}
            </button>
        </div>
    </div>
</div>