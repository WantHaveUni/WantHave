<section class="detail-shell">
  <a routerLink="/products" class="back-link">Back to products</a>

  @if (loading) {
  <div class="loading-state">
    <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
    <p>Loading product...</p>
  </div>
  } @else if (error) {
  <div class="error-state">
    <p>{{ error }}</p>
    <a mat-flat-button color="primary" routerLink="/products">Return to listings</a>
  </div>
  } @else if (product; as product) {
  <mat-card class="detail-card">
    <div class="detail-grid">
      @if (imageUrl(product); as img) {
      <div class="image-shell">
        <img [src]="img" [alt]="product.title" loading="lazy" />
      </div>
      } @else {
      <div class="image-shell placeholder">No image</div>
      }

      <div class="detail-body">
        <div class="header-row">
          <p class="eyebrow">Listing</p>
          @if (!isOwner) {
          <button mat-icon-button (click)="toggleWatchlist($event)" class="watch-btn">
            <mat-icon>{{ product && watchlistIds.has(product.id) ? 'favorite' : 'favorite_border' }}</mat-icon>
          </button>
          }
        </div>
        <h1>{{ product.title }}</h1>
        <p class="price">{{ product.price }} EUR</p>
        <p class="description">{{ product.description }}</p>

        <div class="meta">
          @for (item of details; track item.label) {
          <div class="meta-row">
            <span class="label">{{ item.label }}</span>
            <span class="value">{{ item.value }}</span>
          </div>
          }
        </div>

        <div class="actions">
          <button mat-stroked-button (click)="messageSeller()" [disabled]="!canInteract">Message seller</button>
          <button mat-flat-button color="primary" (click)="startCheckout()"
            [disabled]="processingCheckout || !canInteract || product.status !== 'AVAILABLE'">
            {{ processingCheckout ? 'Processing...' : 'Buy now' }}
          </button>
        </div>

        @if (!auth.isAuthenticated()) {
        <p class="hint">Log in to message or buy this product.</p>
        } @else if (isOwner || auth.isAdmin()) {
        <div class="owner-actions">
          @if (isOwner) {
          <button mat-stroked-button color="primary" (click)="openEditModal()">‚úèÔ∏è Edit</button>
          }
          <button mat-stroked-button color="warn" (click)="deleteProduct()">üóëÔ∏è Delete</button>
        </div>
        @if (isOwner) {
        <p class="hint">You own this listing.</p>
        } @else {
        <p class="hint">Admin Override</p>
        }
        }
      </div>
    </div>
  </mat-card>
  }
</section>

<!-- Edit Modal -->
@if (showEditModal && product) {
<div class="modal-overlay" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Edit Product</h3>
      <button class="modal-close" (click)="closeEditModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="editTitle">Title</label>
        <input type="text" id="editTitle" [(ngModel)]="editData.title" />
      </div>
      <div class="form-group">
        <label for="editDescription">Description</label>
        <textarea id="editDescription" [(ngModel)]="editData.description" rows="4"></textarea>
      </div>
      <div class="form-group">
        <label for="editPrice">Price (EUR)</label>
        <input type="number" id="editPrice" [(ngModel)]="editData.price" min="0" step="0.01" />
      </div>
      <div class="error-message" *ngIf="editError">{{ editError }}</div>
    </div>
    <div class="modal-footer">
      <button mat-stroked-button (click)="closeEditModal()">Cancel</button>
      <button mat-flat-button color="primary" (click)="saveEdit()" [disabled]="editLoading">
        {{ editLoading ? 'Saving...' : 'Save Changes' }}
      </button>
    </div>
  </div>
</div>
}