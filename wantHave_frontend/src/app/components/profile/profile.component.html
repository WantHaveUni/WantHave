<div class="profile-container" [class.edit-mode]="activeView === 'edit'">
  @if (activeView === 'overview') {
  <!-- Profile Overview / Menu View -->
  <div class="profile-overview-container">
    <div class="profile-header">
      <div class="header-pattern"></div>

      <div class="profile-avatar-section">
        <div class="avatar-wrapper">
          @if (profile?.profile_picture) {
          <img [src]="profile!.profile_picture" alt="Profile Picture" class="avatar-image">
          } @else {
          <div class="avatar-placeholder">
            <span class="avatar-icon">ðŸ‘¤</span>
          </div>
          }
        </div>

        <h1 class="username">{{ profile?.user?.username || 'Loading...' }}</h1>
      </div>
    </div>

    @if (loading) {
    <div class="loading-state">
      <p>Loading profile...</p>
    </div>
    }

    @if (error) {
    <div class="error-state">
      <p>{{ error }}</p>
    </div>
    }

    @if (profile && !loading) {
    <!-- Main Menu Items -->
    <div class="menu-section">
      @for (item of mainMenuItems; track item.label) {
      <!-- Use click handler for view switching -->
      <div class="menu-item" (click)="item.view ? setView(item.view) : null">
        <span class="menu-icon">{{ item.icon }}</span>
        <span class="menu-label">{{ item.label }}</span>
        @if (item.badge) {
        <span class="menu-badge">{{ item.badge }}</span>
        }
        <span class="menu-arrow">â€º</span>
      </div>
      }
    </div>

    <!-- Divider -->
    <div class="menu-divider"></div>

    <!-- Bottom Menu Items -->
    <div class="menu-section">
      @for (item of bottomMenuItems; track item.label) {
      <!-- Action binding for items with actions (like Edit Profile) -->
      @if (item.action) {
      <div class="menu-item" (click)="item.action!()">
        <span class="menu-icon">{{ item.icon }}</span>
        <span class="menu-label">{{ item.label }}</span>
        <span class="menu-arrow">â€º</span>
      </div>
      } @else {
      <a [routerLink]="item.route" class="menu-item">
        <span class="menu-icon">{{ item.icon }}</span>
        <span class="menu-label">{{ item.label }}</span>
        <span class="menu-arrow">â€º</span>
      </a>
      }
      }
    </div>
    }
  </div>
  }

  <!-- Feature Views (SPA) -->
  @if (activeView === 'listings') {
  <app-my-listings (goBack)="setView('overview')"></app-my-listings>
  }
  @if (activeView === 'transactions') {
  <app-my-transactions (goBack)="setView('overview')"></app-my-transactions>
  }
  @if (activeView === 'watchlist') {
  <app-watchlist (goBack)="setView('overview')"></app-watchlist>
  }

  @if (activeView === 'edit' && profile) {
  <!-- Edit Profile View -->
  <div class="profile-edit-container">
    <div class="edit-header">
      <h2>Edit Profile</h2>
    </div>

    @if (error) {
    <div class="edit-error-alert">
      {{ error }}
    </div>
    }

    <form [formGroup]="profileForm" (ngSubmit)="saveProfile()">

      <!-- Profile Picture Section -->
      <div class="form-section profile-picture-section">
        <div class="picture-wrapper">
          <img [src]="previewUrl || profile.profile_picture || 'assets/default-avatar.svg'" alt="Profile Picture"
            class="edit-picture">
          <label for="profile_picture" class="camera-icon-label">
            ðŸ“·
            <input type="file" id="profile_picture" (change)="onFileSelected($event)" accept="image/*"
              class="hidden-input">
          </label>
        </div>
      </div>

      <!-- Public Data -->
      <div class="form-section">
        <h3>Public Data</h3>

        <div class="form-row">
          <div class="form-group">
            <label>First Name</label>
            <input type="text" formControlName="first_name" placeholder="First Name">
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input type="text" formControlName="last_name" placeholder="Last Name">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group small-col">
            <label>Zip Code</label>
            <input type="text" formControlName="zip_code" placeholder="Zip">
          </div>
          <div class="form-group">
            <label>City</label>
            <input type="text" formControlName="city" placeholder="City">
          </div>
        </div>

        <div class="form-group">
          <label>Country</label>
          <input type="text" formControlName="country" placeholder="Enter Country">
        </div>
      </div>

      <!-- Private Data -->
      <div class="form-section">
        <h3>Private Data (visible only to you)</h3>

        <div class="private-row">
          <div class="input-wrapper">
            <label>Username</label>
            <input type="text" [value]="profile.user.username" readonly>
          </div>
          <button type="button" class="change-btn" (click)="usernameChangeRequest()">CHANGE</button>
        </div>

        @if (isChangingUsername) {
        <div class="security-change-panel" [formGroup]="securityForm">
          <h4>Change Username</h4>

          @if (securityError && isChangingUsername) {
          <div class="edit-error-alert small-alert">
            {{ securityError }}
          </div>
          }
          @if (securitySuccess && isChangingUsername) {
          <div class="edit-success-alert small-alert">
            {{ securitySuccess }}
          </div>
          }

          <div class="form-group">
            <label>New Username</label>
            <input type="text" formControlName="username" placeholder="New Username">
          </div>
          <div class="form-group">
            <label>Current Password</label>
            <input type="password" formControlName="current_password" placeholder="Confirm with Password">
          </div>
          <div class="form-actions small-actions">
            <button type="button" class="save-button" (click)="submitUsernameChange()" [disabled]="saving">Update
              Username</button>
            <button type="button" class="cancel-button" (click)="cancelSecurityChange()">Cancel</button>
          </div>
        </div>
        }

        <div class="private-row">
          <div class="input-wrapper">
            <label>Email</label>
            <input type="email" formControlName="email" readonly>
          </div>
          <button type="button" class="change-btn" (click)="emailChangeRequest()">CHANGE</button>
        </div>

        @if (isChangingEmail) {
        <div class="security-change-panel" [formGroup]="securityForm">
          <h4>Change Email</h4>

          @if (securityError) {
          <div class="edit-error-alert small-alert">
            {{ securityError }}
          </div>
          }
          @if (securitySuccess) {
          <div class="edit-success-alert small-alert">
            {{ securitySuccess }}
          </div>
          }

          <div class="form-group">
            <label>New Email</label>
            <input type="email" formControlName="new_email" placeholder="New Email Address">
          </div>
          <div class="form-group">
            <label>Current Password</label>
            <input type="password" formControlName="current_password" placeholder="Confirm with Password">
          </div>
          <div class="form-actions small-actions">
            <button type="button" class="save-button" (click)="submitEmailChange()" [disabled]="saving">Update
              Email</button>
            <button type="button" class="cancel-button" (click)="cancelSecurityChange()">Cancel</button>
          </div>
        </div>
        }

        <div class="private-row">
          <div class="input-wrapper">
            <label>Password</label>
            <input type="password" value="********" readonly>
          </div>
          <button type="button" class="change-btn" (click)="passwordChangeRequest()">CHANGE</button>
        </div>

        @if (isChangingPassword) {
        <div class="security-change-panel" [formGroup]="securityForm">
          <h4>Change Password</h4>

          @if (securityError) {
          <div class="edit-error-alert small-alert">
            {{ securityError }}
          </div>
          }
          @if (securitySuccess) {
          <div class="edit-success-alert small-alert">
            {{ securitySuccess }}
          </div>
          }

          <div class="form-group">
            <label>Old Password</label>
            <input type="password" formControlName="old_password" placeholder="Current Password">
          </div>
          <div class="form-group">
            <label>New Password</label>
            <input type="password" formControlName="new_password" placeholder="New Password">
          </div>
          <div class="form-actions small-actions">
            <button type="button" class="save-button" (click)="submitPasswordChange()" [disabled]="saving">Update
              Password</button>
            <button type="button" class="cancel-button" (click)="cancelSecurityChange()">Cancel</button>
          </div>
        </div>
        }

      </div>

      <div class="form-actions center-actions">
        <button type="submit" class="save-button" [disabled]="saving || profileForm.invalid">
          {{ saving ? 'Saving...' : 'Save Changes' }}
        </button>
        <button type="button" class="cancel-button" (click)="cancelEdit()" [disabled]="saving">
          Cancel
        </button>
      </div>
    </form>

    <div class="danger-zone">
      <h3>Danger Zone</h3>
      <button type="button" class="delete-button" (click)="deleteAccount()">
        Delete Account
      </button>
    </div>
  </div>
  }
</div>