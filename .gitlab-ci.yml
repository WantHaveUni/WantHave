stages:
  - deploy

# Define the image tag based on the commit SHA that GitHub
variables:
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA

deploy_dev:
  stage: deploy
  image: argoproj/argocd:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
  script:
    # Update Backend Application
    - |
      echo "Deploying Backend with tag: $IMAGE_TAG"
      argocd app set wanthave-backend-dev \
        --server "$ARGOCD_SERVER" --grpc-web --insecure --auth-token "$ARGOCD_TOKEN" \
        -p image.tag="$IMAGE_TAG"
      argocd app sync wanthave-backend-dev \
        --server "$ARGOCD_SERVER" --grpc-web --insecure --auth-token "$ARGOCD_TOKEN" \
        --prune
    
    # Update Frontend Application
    - |
      echo "Deploying Frontend with tag: $IMAGE_TAG"
      argocd app set wanthave-frontend-dev \
        --server "$ARGOCD_SERVER" --grpc-web --insecure --auth-token "$ARGOCD_TOKEN" \
        -p image.tag="$IMAGE_TAG"
      argocd app sync wanthave-frontend-dev \
        --server "$ARGOCD_SERVER" --grpc-web --insecure --auth-token "$ARGOCD_TOKEN" \
        --prune
        
    # Wait for health (Optional, keeps pipeline honest)
    - argocd app wait wanthave-backend-dev --server "$ARGOCD_SERVER" --grpc-web --insecure --auth-token "$ARGOCD_TOKEN" --health --timeout 180
    - argocd app wait wanthave-frontend-dev --server "$ARGOCD_SERVER" --grpc-web --insecure --auth-token "$ARGOCD_TOKEN" --health --timeout 180

deploy_main:
  stage: deploy
  image: argoproj/argocd:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    # Logic for production/main deployment
    - echo "Deploying to Production..."
    
    # We DO NOT manually update ArgoCD app here.
    # Why?
    # 1. We pushed a change to 'main' including the new Chart.yaml version.
    # 2. ArgoCD watches the Git Repo.
    # 3. ArgoCD sees 'Chart.yaml' changed (AppVersion changed).
    # 4. ArgoCD renders manifest -> Image Tag is now the new AppVersion.
    # 5. ArgoCD syncs automatically.
    
    - echo "Waiting for ArgoCD to detect Git change and sync..."
    # Optionally, we could manually trigger a sync just to be fast, but strictly speaking,
    # "ArgoCD detects Git-Change" implies we leave it to the controller.
    # However, to be helpful, we can just ensure the sync happens:
    
    - argocd app sync wanthave-backend --server "$ARGOCD_SERVER" --grpc-web --insecure --auth-token "$ARGOCD_TOKEN"
    - argocd app sync wanthave-frontend --server "$ARGOCD_SERVER" --grpc-web --insecure --auth-token "$ARGOCD_TOKEN"